---
title: "SingleCellMQC QC Report"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    css: bootstrap.css
    toc: true
    toc_float: 
      collapsed: true      
      smooth_scroll: true  
    number_sections: true
    self_contained: false
#    self_contained: false
params:
  data: out_list
  cell_dir: plot_dir
lang: en
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(echo = TRUE)
```

```{r function, echo=FALSE}
# params:
#   data: out_list
#   cell_dir: plot_dir
subchunkify <- function(g, fig_height=7, fig_width=5, seed=floor(runif(1) * 10000)) {
  g_deparsed <- paste0(deparse(
    function() {g}
  ), collapse = '')

  sub_chunk <- paste0("`","``{r sub_chunk_", seed, ", fig.height=",
   fig_height, ", fig.width=", fig_width, ", echo=FALSE, warning=FALSE, message=FALSE}",
  "\n(", 
    g_deparsed
    , ")()",
  "\n`","``
  ")

  cat(knitr::knit(text = knitr::knit_expand(text = sub_chunk), quiet = TRUE))
}

bar_style <- function(width = 1, fill = "#e6e6e6", height = "75%",
                      align = c("left", "right"), color = NULL) {
  align <- match.arg(align)
  if (align == "left") {
    position <- paste0(width * 100, "%")
    image <- sprintf("linear-gradient(90deg, %1$s %2$s, transparent %2$s)", fill, position)
  } else {
    position <- paste0(100 - width * 100, "%")
    image <- sprintf("linear-gradient(90deg, transparent %1$s, %2$s %1$s)", position, fill)
  }
  list(
    backgroundImage = image,
    backgroundSize = paste("100%", height),
    backgroundRepeat = "no-repeat",
    backgroundPosition = "center",
    color = color
  )
}

btn <- function(xLoc, m, nms, xOry, data) { # x btn position, method, names, x or y
  list(type = "list", x = xLoc, xanchor = "left", y = 1.2, 
       buttons = lapply(
         nms, function(k) {           # iterate over names
           list(
             method = m, label = k,
             args = if(xOry == "x"){
               list( # a list for each trace (each legend entry)
                 list(x = list(data[, k] )),  # 3 lists, 3 traces
                 list(xaxis = list(title = k)))
             }else{
               list(
                 list(y = list(data[, k] )),  # 3 lists, 3 traces
                 list(yaxis = list(title = k)))
             }
           )}
       )
  )}

warning_alert_orange <- function(text) {
  cat(sprintf('<div class="alert alert-warning">
  <h5 class="alert-heading" style="font-size: 20px;" aria-hidden="true">Warning!</h5>
  %s
</div>', text))
}
warning_alert_red <- function(text) {
  cat(sprintf('<div class="alert alert-dismissible alert-danger">
  <h5 class="alert-heading" style="font-size: 20px;" aria-hidden="true">Warning!</h5>
  %s
</div>', text))
}

note_grey <- function(text) {
  cat(sprintf('<div class="alert alert-dismissible alert-light">
  %s
</div>', text))
}

metrics_help_details <- function(
  title,
  items,
  open  = FALSE,
  icon  = "\u2139\uFE0F",    # ℹ️，可换成 "?" 等
  label = icon               # summary 里显示什么
) {
  stopifnot(is.character(title), length(title) == 1)
  items <- htmltools::htmlEscape(items)  # 防止特殊字符破坏 HTML

  body_md <- paste0("- ", items, collapse = "\n")
  details_open <- if (isTRUE(open)) " open" else ""
  title_esc <- htmltools::htmlEscape(title)
  summary_label <- htmltools::htmlEscape(label)

  block <- paste0(
    "<details class=\"metrics-help\"", details_open, ">\n",
    "<summary aria-label=\"", title_esc, "\">", summary_label, "</summary>\n\n",
    "**", title_esc, "**\n\n",
    body_md, "\n",
    "</details>\n"
  )

  if (isTRUE(getOption("knitr.in.progress"))) {
    knitr::asis_output(block)
  } else {
    cat(block)
    invisible(block)
  }
}


data <- params$data
cell_dir <- params$cell_dir

```

```{r setup Bootstrap Alert, include=FALSE}
# 通用函数来生成 Bootstrap Alert
generate_bs_alert <- function(text, type = "info", title = NULL, dismissible = FALSE) {
  # 构建 CSS 类
  alert_class <- paste0("alert alert-", type)
  if (dismissible) {
    alert_class <- paste(alert_class, "alert-dismissible fade show") # fade show for animation
  }
  # 构建标题
  title_html <- ""
  if (!is.null(title)) {
    title_html <- sprintf('<h5 class="alert-heading" style="font-size: 20px;">%s</h5>', title)
  }
  # 构建关闭按钮 (如果可关闭)
  close_button <- ""
  if (dismissible) {
    close_button <- '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>'
  }
  # 组合 HTML
  html_output <- sprintf(
    '<div class="%s" role="alert">%s%s%s</div>',
    alert_class,
    close_button, # Close button usually comes first for styling
    title_html,
    text
  )
  cat(html_output)
}
# --- 特定类型的包装函数 ---
# 1. Primary (蓝色，主要信息)
primary_alert <- function(text, title = "Primary Message", dismissible = FALSE) {
  generate_bs_alert(text, "primary", title, dismissible)
}
# 2. Secondary (灰色，次要信息)
secondary_alert <- function(text, title = "Secondary Information", dismissible = FALSE) {
  generate_bs_alert(text, "secondary", title, dismissible)
}
# 3. Success (绿色，成功)
success_alert <- function(text, title = "Success!", dismissible = FALSE) {
  generate_bs_alert(text, "success", title, dismissible)
}
# 4. Danger (红色，错误/危险) - 你已有的 warning_alert_red 类似
danger_alert <- function(text, title = "Error!", dismissible = FALSE) {
  generate_bs_alert(text, "danger", title, dismissible)
}
# 5. Warning (黄色，警告) - 你已有的 warning_alert_orange 类似
warning_alert <- function(text, title = "Warning!", dismissible = FALSE) {
  generate_bs_alert(text, "warning", title, dismissible)
}
# 6. Info (浅蓝色，一般信息/提示)
info_alert <- function(text, title = "Information", dismissible = FALSE) {
  generate_bs_alert(text, "info", title, dismissible)
}
# 7. Light (浅灰色，中性信息) - 你已有的 note_grey 类似
light_alert <- function(text, title = NULL, dismissible = FALSE) {
  generate_bs_alert(text, "light", title, dismissible)
}
# 8. Dark (深灰色，深色背景信息)
dark_alert <- function(text, title = "Dark Message", dismissible = FALSE) {
  generate_bs_alert(text, "dark", title, dismissible)
}
```

```{r setup Bootstrap Card, include=FALSE}
# 通用函数来生成 Bootstrap Card
generate_bs_card <- function(header_content = NULL, # 用于卡片头部的内容
                             card_title = NULL,     # 用于卡片主体内部的标题
                             body_content = NULL,   # 卡片主体内容
                             footer_content = NULL, # 卡片页脚内容
                             header_bg = NULL, body_bg = NULL, footer_bg = NULL,
                             text_color = NULL, border_color = NULL,
                             card_class = "",       # 额外的 card 样式类
                             header_class = "",     # 额外的 header 样式类
                             card_title_class = "", # 额外的 card title 样式类
                             body_class = "",       # 额外的 body 样式类
                             footer_class = "") {   # 额外的 footer 样式类

  # 构建卡片类
  final_card_class <- "card"
  if (card_class != "") {
    final_card_class <- paste(final_card_class, card_class)
  }
  if (!is.null(border_color)) {
    final_card_class <- paste(final_card_class, paste0("border-", border_color))
  }
  if (!is.null(text_color)) {
    final_card_class <- paste(final_card_class, paste0("text-", text_color))
  }

  # 构建卡片头部
  header_html <- ""
  if (!is.null(header_content)) {
    header_classes <- "card-header"
    if (!is.null(header_bg)) {
      header_classes <- paste(header_classes, paste0("bg-", header_bg))
    }
    if (header_class != "") { # 使用新的 header_class
      header_classes <- paste(header_classes, header_class)
    }
    header_html <- sprintf('<div class="%s">%s</div>', header_classes, header_content)
  }

  # 构建卡片主体内容，包括卡片标题
  body_content_html <- ""
  if (!is.null(card_title)) {
    body_content_html <- paste0(body_content_html, sprintf('<h5 class="card-title %s">%s</h5>', card_title_class, card_title))
  }
  if (!is.null(body_content)) {
    body_content_html <- paste0(body_content_html, sprintf('<p class="card-text">%s</p>', body_content))
  }

  # 构建卡片主体 div
  body_html <- ""
  if (body_content_html != "") {
    body_classes <- "card-body"
    if (!is.null(body_bg)) {
      body_classes <- paste(body_classes, paste0("bg-", body_bg))
    }
    if (body_class != "") {
      body_classes <- paste(body_classes, body_class)
    }
    body_html <- sprintf('<div class="%s">%s</div>', body_classes, body_content_html)
  }

  # 构建卡片底部
  footer_html <- ""
  if (!is.null(footer_content)) {
    footer_classes <- "card-footer"
    if (!is.null(footer_bg)) {
      footer_classes <- paste(footer_classes, paste0("bg-", footer_bg))
    }
    if (footer_class != "") {
      footer_classes <- paste(footer_classes, footer_class)
    }
    footer_html <- sprintf('<div class="%s">%s</div>', footer_classes, footer_content)
  }

  # 组合 HTML
  html_output <- sprintf(
    '<div class="%s">%s%s%s</div>',
    final_card_class,
    header_html,
    body_html,
    footer_html
  )
  cat(html_output)
}

# --- 特定类型的包装函数 (可选，方便常用样式) ---
# 1. Primary 风格的卡片 (通常是蓝色背景，白色文字，带有黑色边框)
generate_primary_card <- function(
  header_content = "Header",
  card_title = "Primary card title",
  body_content = "Some quick example text to build on the card title and make up the bulk of the card's content.",
  footer_content = NULL, # 新增 footer_content 参数，默认 NULL
  card_class = "mb-4"
) {
  generate_bs_card(
    header_content = header_content,
    card_title = card_title,
    body_content = body_content,
    footer_content = footer_content, # 传递 footer_content
    header_bg = NULL,
    body_bg = NULL,
    text_color = NULL,
    border_color = "black",
    card_class = card_class
  )
}
# 2. Info 风格的卡片 (蓝色背景，白色文字，Header 也是蓝色背景，蓝色边框)
generate_info_card <- function(
  header_content = "Header",
  card_title = "Info card title",
  body_content = "Some quick example text to build on the card title and make up the bulk of the card's content.",
  footer_content = NULL, # 新增 footer_content 参数，默认 NULL
  card_class = "mb-4"
) {
  generate_bs_card(
    header_content = header_content,
    card_title = card_title,
    body_content = body_content,
    footer_content = footer_content, # 传递 footer_content
    header_bg = "info",
    body_bg = "info",
    text_color = "white",
    border_color = "info",
    card_class = card_class
  )
}
# 3. Light 风格的卡片 (浅灰色背景，深色文字，Header 也是浅灰色背景，浅灰色边框)
generate_light_card <- function(
  header_content = "Header",
  card_title = "Light card title",
  body_content = "Some quick example text to build on the card title and make up the bulk of the card's content.",
  footer_content = NULL, # 新增 footer_content 参数，默认 NULL
  card_class = "mb-4"
) {
  generate_bs_card(
    header_content = header_content,
    card_title = card_title,
    body_content = body_content,
    footer_content = footer_content, # 传递 footer_content
    header_bg = "light",
    body_bg = "light",
    text_color = "black",
    border_color = "light",
    card_class = card_class
  )
}

```



```{r Sample QC, echo=FALSE, results='asis'}
if (!is.null(data$Sample)) {
  cat(knitr::knit_child("Sample_QC.Rmd", quiet = TRUE))
  cat("\n\n")
}
```


```{r Cell QC, echo=FALSE, results='asis'}
 if (!is.null(data$Cell)) {
   cat(knitr::knit_child("Cell_QC.Rmd", quiet = TRUE))
     cat("\n\n")
 }
```



```{r Feature QC, echo=FALSE, results='asis'}
 if (!is.null(data$Feature)) {
   cat(knitr::knit_child("Feature_QC.Rmd", quiet = TRUE))
     cat("\n\n")

}
```


```{r Batch QC, echo=FALSE, results='asis'}
 if (!is.null(data$Batch)) {
   cat(knitr::knit_child("Batch_QC.Rmd", quiet = TRUE))
    cat("\n\n")

 }
```



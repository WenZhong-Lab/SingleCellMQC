---
title: "batch_QC"
output: html_document
---

---------------------------------------------------

# Batch QC 

Batch-to-batch variation is a significant challenge in single-cell analysis, where differences in protocols, reagents, and experimental conditions can introduce noise that obscures true biological signals and leads to misleading interpretations. **You can evaluate batch effects at sample, cell and feature levels.**

```{r pseudobulk batch, echo=FALSE, results='asis', warning=FALSE}

if(length(data$Batch$Section1$pseudobulk_RNA)!=0 |  length(data$Batch$Section1$pseudobulk_ADT)!=0) {
    cat(paste0("## ", "Sample-level QC", " {.tabset }\n"))
  cat('\n\n')
  
  cat(paste0("### ", "Pseudobulk PCA", " {.tabset .unnumbered}\n"))
  cat('\n\n')

  cat("This section applies PCA on pseudobulk single-cell data at the sample level, aggregating count data to quickly check batch effects across samples. \n")
  cat('\n\n')
  if(length(data$Batch$Section1$pseudobulk_RNA)!=0){
    for (i in data$Batch$Section1$pseudobulk_RNA) {
      cat(paste0("#### ", i, " {.tabset .unnumbered}\n"))
      cat("![](", paste0(cell_dir, "/Batch_effect/pseudobulk/",  paste0(i,".png")), ")")
      cat('\n\n')
      # cat("**Figure: ** The PCA analysis of pseudobulk data. \n\n")
      cat('\n\n')
      
      cat(paste0("This plot shows the PCA analysis of pseudobulk data, which can assist in evaluating the batch effects between samples. ", "**IF you want to see interactive plotly object for details, you can see it by click the link ", "[plotly_link](", paste0( "./SingleCellMQC/plot/Batch_effect/pseudobulk/",  paste0(i, ".html")), ")", ".**\n\n")) 
    }
  }
  
  if(length(data$Batch$Section1$pseudobulk_ADT)!=0){
    for (i in data$Batch$Section1$pseudobulk_ADT) {
      cat(paste0("#### ", i, " {.tabset .unnumbered}\n"))
      cat("![](", paste0(cell_dir, "/Batch_effect/pseudobulk/",  paste0(i,".png")), ")")
      cat('\n\n')
      # cat("**Figure: ** The PCA analysis of pseudobulk data. \n\n")
      cat('\n\n')
      
      cat(paste0("This plot shows the PCA analysis of pseudobulk data, which can assist in evaluating the batch effects between samples. ", "**IF you want to see interactive plotly object for details, you can see it by click the link ", "[plotly_link](", paste0( "./SingleCellMQC/plot/Batch_effect/pseudobulk/",  paste0(i, ".html")), ")", ".**\n\n")) 
    }
  }
}



```


```{r CovariateImpact, echo=FALSE, results='asis', warning=FALSE}

if(length(data$Batch$Section1$pseudobulk_RNA_VP)!=0 |  length(data$Batch$Section1$pseudobulk_RNA_VP_celltype)!=0 | length(data$Batch$Section1$pseudobulk_ADT_VP)!=0 | length(data$Batch$Section1$pseudobulk_ADT_VP_celltype)!=0 ) {
  cat(paste0("### ", "Covariate impact", " {.tabset .unnumbered}\n"))
  cat('\n\n')
  cat("This section performs  \n")
    cat('\n\n')
  if(length(data$Batch$Section1$pseudobulk_RNA_VP)!=0){
    cat(paste0("#### ", "RNA Pseudobulk", " {.tabset .unnumbered}\n"))
    temp <- data$Batch$Section1$pseudobulk_RNA_VP
    cat("![](", paste0(cell_dir, "/Batch_effect/pseudobulk/",  paste0(temp)), ")")
    cat('\n\n')
  }
  if(length(data$Batch$Section1$pseudobulk_RNA_VP_celltype)!=0){
    temp <- data$Batch$Section1$pseudobulk_RNA_VP_celltype
    cat("![](", paste0(cell_dir, "/Batch_effect/pseudobulk/",  paste0(temp)), ")")
    cat('\n\n')
  }
    
  if(length(data$Batch$Section1$pseudobulk_ADT_VP)!=0){
    cat(paste0("#### ", "ADT Pseudobulk", " {.tabset .unnumbered}\n"))
    temp <- data$Batch$Section1$pseudobulk_ADT_VP
    cat("![](", paste0(cell_dir, "/Batch_effect/pseudobulk/",  paste0(temp)), ")")
    cat('\n\n')
  }
  if(length(data$Batch$Section1$pseudobulk_ADT_VP_celltype)!=0){
    temp <- data$Batch$Section1$pseudobulk_ADT_VP_celltype
    cat("![](", paste0(cell_dir, "/Batch_effect/pseudobulk/",  paste0(temp)), ")")
    cat('\n\n')
  }
    
  cat('\n\n')
}

```


```{r cell_batch_information, echo=FALSE, results='asis', warning=FALSE }
 if(length(data$Batch$Section2$cell_RNA)!=0 |  length(data$Batch$Section2$cell_ADT)!=0) {
   cat(paste0("## ", " Cell-level QC", " {.tabset }\n"))
   cat("\n\n")
   cat("This section evaluates batch effects using high-dimensional reduction techniques. At single-cell level, for single-omic data (RNA or ADT counts), preprocessing, dimension reduction and clustering steps in SingleCellMQC are done using Seurat or BPCells analysis pipeline. The results of clustering are visualized by UMAP dimensionality reduction to evaluate batch effect.")
 }

```


```{r clustering test, echo=FALSE, results='asis', warning=FALSE}

if(length(data$Batch$Section2$test_RNA)!=0){
  warning_alert_orange(paste0("Single-cell RNA data: ", data$Batch$Section2$test_RNA))
    cat("\n\n")
}
if(length(data$Batch$Section2$test_ADT)!=0){
  warning_alert_orange( paste0("Single-cell ADT data: ", data$Batch$Section2$test_ADT) )
  cat("\n\n")
}

```

```{r cell clustering RNA, echo=FALSE, results='asis', warning=FALSE}

if(length(data$Batch$Section2$cell_RNA)!=0 |  length(data$Batch$Section2$cell_ADT)!=0) {
  # cat(paste0("### ", "Cell", " {.tabset .unnumbered}\n"))
  cat('\n\n')
  if(length(data$Batch$Section2$cell_RNA)!=0){
    for (i in names(data$Batch$Section2$cell_RNA) ) {
      cat(paste0("### ", i, " {.tabset .unnumbered}\n"))
      for (j in data$Batch$Section2$cell_RNA[[i]]) {
        cat(paste0("#### ", j, " {.tabset .unnumbered}\n"))
        cat("![](", paste0(cell_dir, "/Batch_effect/cell/",  paste0(j,".png")), ")")
        cat('\n\n')
        # cat("**Figure: ** The UMAP of cell data. \n\n")
        cat('\n\n')
      }
    
    }
  }
  
  if(length(data$Batch$Section2$cell_ADT)!=0){
    for (i in names(data$Batch$Section2$cell_ADT) ) {
      cat(paste0("### ", i, " {.tabset .unnumbered}\n"))
      for (j in data$Batch$Section2$cell_ADT[[i]]) {
        cat(paste0("#### ", j, " {.tabset .unnumbered}\n"))
        cat("![](", paste0(cell_dir, "/Batch_effect/cell/",  paste0(j,".png")), ")")
        cat('\n\n')
        # cat("**Figure: ** The UMAP of cell data. \n\n")
        cat('\n\n')
      }
    
    }
  }
}



```



```{r GTE_batch, echo=FALSE, results='asis', warning=FALSE}

if(length(data$Batch$Section3$RNA)!=0){
  cat(paste0("## ", "Feature-level QC", " {.tabset }\n"))
  cat("At the feature level, SingleCellMQC integrates the group technical effects (GTE) metric to assess impact of batch effects on individual features ([Github link](https://github.com/yzhou1999/GTEs/)). This assessment aims to identify and quantify features exhibiting a larger degree of influence from batch covariates, thereby assisting users in understanding and addressing technical variations within their data. \n\n")
  
  if(length(data$Batch$Section3$RNA)!=0){
    cat(paste0("### ", "RNA", " {.tabset .unnumbered }\n"))
    
    for (i in names(data$Batch$Section3$RNA) ) {
      cat(paste0("#### ", i, " {.tabset .unnumbered}\n"))
      cat('\n\n')
      
      subchunkify(data$Batch$Section3$RNA[[i]], seed=paste0("GTE_RNA_", i))
      
      cat('\n\n')
      }
  }
  
  if(length(data$Batch$Section3$ADT)!=0){
    cat(paste0("### ", "ADT", " {.tabset .unnumbered }\n"))
    
    for (i in names(data$Batch$Section3$ADT) ) {
      cat(paste0("#### ", i, " {.tabset .unnumbered}\n"))
      cat('\n\n')
      
      subchunkify(data$Batch$Section3$ADT[[i]], seed=paste0("GTE_ADT_", i))
      
      cat('\n\n')
      }
  }
}


```
